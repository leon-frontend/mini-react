# 01. 任务调度算法（小顶堆）

- **小顶堆**：是⼀种经过排序的完全⼆叉树，其中任⼀⾮终端节点的数据值均不⼤于其左⼦节点和右⼦节点的值。
- **自顶向下堆化**：只需要**遍历前面一半**的元素即可。此外，需要注意右子节点可能不存在。

| 推算节点下标                   | 公式                                   |
| ------------------------------ | -------------------------------------- |
| 根据⼦节点下标推算⽗节点下标   | `parentIndex = (childIndex - 1) >>> 1` |
| 根据父节点下标推算左子节点下标 | `leftIndex = (index + 1) * 2 - 1`      |

# 02. 任务优先级

| **优先级常量**         | **值** | **描述**                         |
| ---------------------- | ------ | -------------------------------- |
| `ImmediatePriority`    | 1      | 立即执行（最高优先级）           |
| `UserBlockingPriority` | 2      | 用户输入相关                     |
| `NormalPriority`       | 3      | 默认任务                         |
| `LowPriority`          | 4      | 可以延迟的任务                   |
| `IdlePriority`         | 5      | 浏览器空闲时才执行的任务（最低） |

# 03. Scheduler 的核心 API

| **API 名称**                     | **作用**                                                     |
| -------------------------------- | ------------------------------------------------------------ |
| `scheduleCallback(priority, cb)` | 将任务按照指定优先级执行。其返回值为 `callbackNode` 可用于取消任务。 |
| `cancelCallback(callbackNode)`   | 取消尚未执行的任务。在用户操作变化、任务失效时使用。         |
| `shouldYield()`                  | 判断是否需要让出主线程时间。用于实现时间分片。               |
| `getCurrentPriorityLevel()`      | 获取当前正在执行的任务的优先级。用于调试调度行为、日志记录等。 |

# 04. 时间分片

- **核心思想**：将大型的渲染任务分解成多个小的任务，然后让浏览器在每个“时间片”中执行一小部分工作。这些时间片通常是非常短的，在每一片段之间允许浏览器去处理其他重要的任务，比如用户输入、动画更新、网络请求等。
- **异步渲染**：React 使用**异步渲染**来实现时间分片。通过将更新工作分割成多个任务，React 可以在每个任务间插入**空闲时间**（通常是通过 `requestIdleCallback` 实现），让浏览器有机会处理优先级高的事件。

- **callback & task & work 之间的关系**：callback 可以理解为一个需要执行的任务；task 封装了和任务相关的信息；work 表示一个时间切片内的工作单元。

```ts
export type Task = {
  id: number;
  callback: Callback | null;
  priorityLevel: PriorityLevel; // 优先级
  startTime: number; // 任务开始时间
  expirationTime: number; // 任务结束时间
  sortIndex: number; // 小顶堆的排序依据。会综合考虑优先级、任务开始时间和任务结束时间。
}
```

- **shouldYield 函数**：React 在渲染过程中会定期检查是否需要**中断当前任务**，并让出主线程给其他任务。shouldYield 函数就是用来执行这种检查的，它判断当前任务是否应该暂停，以便执行其他更重要的任务（例如，用户点击、滚动等）。
